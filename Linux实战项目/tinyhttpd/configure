#!/bin/bash

PATH_ROOT=$(pwd)
THREAD_POOL_PATH=$(pwd)/ThreadPool
INCLUDE=-I${THREAD_POOL_PATH}
SRC=$(ls *.cpp | tr '\n' ' ')
OBJ=$(echo ${SRC} | sed  's/\.cpp/\.o/g' )
POOL_SRC=$(ls ${THREAD_POOL_PATH}/*.cpp | tr '\n' ' ' | sed  's/\.cpp/\.o/g' )
POOL_OBJ=$(echo ${POOL_SRC##*/})
SERVER_NAME=httpd
cc=g++
lib=-lpthread

#cgi
CGI_PATH=${PATH_ROOT}/cgi-bin
MATH_SRC=$(ls ${CGI_PATH} | grep "math" | grep -E '.c$')
MATH_BIN=cgi_math

cat << EOF > ${CGI_PATH}/Makefile
${MATH_BIN}:${MATH_SRC}
	gcc -o \$@ \$^
.PHONY:clean
clean:
	rm -f ${MATH_BIN}
EOF

# sql
SQL_LIB=$(pwd)/lib
SQL_PATH=$(pwd)/mysql_cgi
SQL_API=${SQL_PATH}/mysql_api.cpp

# http
cat << EOF > Makefile
.PHONY:all
all:${SERVER_NAME} cgi

${SERVER_NAME}:${OBJ} ${POOL_OBJ}
	${cc} -o \$@ \$^ ${lib}
%.o:${ROOT_PATH}/%.cpp
	${cc} -c \$< ${INCLUDE}
%.o:${THREAD_POOL_PATH}/%.cpp
	${cc} -c \$< 
	
.PHONY:cgi
cgi:
	cd cgi-bin; make; cd -
	cd mysql_cgi; make; cd -

.PHONY:output
output:all
	mkdir output
	cp ${SERVER_NAME} output/
	cp -rf log output/
	cp -rf conf	output/
	cp -rf wwwRoot	output/
	mkdir -p output/wwwRoot/cgi/sql
	cp ${CGI_PATH}/${MATH_BIN}	output/wwwRoot/cgi/
	cp http_ctl.sh output/http_ctl
#	cp -rf ${SQL_LIB}/lib output/
	cp ${SQL_PATH}/cgi_select output/wwwRoot/cgi/sql/
	cp ${SQL_PATH}/cgi_insert output/wwwRoot/cgi/sql/
	cp ${SQL_PATH}/cgi_modify output/wwwRoot/cgi/sql/
	cp ${SQL_PATH}/cgi_delete output/wwwRoot/cgi/sql/

.PHONY:clean
clean:
	rm -rf ${SERVER_NAME} *.o output
	cd ${CGI_PATH};make clean; cd -
	cd ${SQL_PATH}; make clean; cd -
EOF

